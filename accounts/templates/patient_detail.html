{% extends "authenticated_base.html" %}
{% block title %}
    Patient Details
{% endblock title %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center">Patient Details</h2>
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">{{ patient.username }} - {{ patient.reg_id }}</h4>
        </div>
        <div class="card-body">
            <form id="patientForm" method="POST" action="{% url 'patient_update' patient.id %}">
                {% csrf_token %}
                <div class="row mb-3">
                    <div class="col-md-4">
                        <h6>Name:</h6>
                        <input type="text" class="form-control" name="username" value="{{ patient.username }}" disabled>
                    </div>
                    <div class="col-md-4">
                        <h6>Address:</h6>
                        <input type="text" class="form-control" name="address" value="{{ patient.address }}" disabled>
                    </div>
                    <div class="col-md-4">
                        <h6>Contact Number:</h6>
                        <input type="text" class="form-control" name="phone_number" value="{{ patient.phone_number }}" disabled>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-12">
                        <h6>Condition:</h6>
                        <input type="text" class="form-control" name="condition" value="{{ patient.condition }}" disabled>
                    </div>
                </div>
                <button type="button" id="editButton" class="btn btn-primary">Edit</button>
                <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#confirmDeleteModal">Delete</button>
                <button type="submit" id="saveButton" class="btn btn-success" style="display: none;">Save changes</button>
            </form>
            <div id="responseMessage"></div>
        </div>
    </div>
</div>
<!-- Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this patient? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <form method="POST" action="{% url 'patient_delete' patient.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('#editButton').on('click', function() {
            // Enable all input fields
            $('#patientForm input').prop('disabled', false);
            $(this).hide();  // Hide the Edit button
            $('#saveButton').show();  // Show the Save button
        });

        $('#patientForm').on('submit', function(event) {
            event.preventDefault();  // Prevent the default form submission

            const form = $(this);
            const url = form.attr('action');

            $.ajax({
                type: 'POST',
                url: url,
                data: form.serialize(),
                success: function(response) {
                    if (response.status === 'success') {
                        $('#responseMessage').html('<div class="alert alert-success">Patient updated successfully!</div>');
                        // Update displayed values with the returned data
                        $('input[name="username"]').val(response.username).prop('disabled', true);
                        $('input[name="address"]').val(response.address).prop('disabled', true);
                        $('input[name="phone_number"]').val(response.phone_number).prop('disabled', true);
                        $('input[name="condition"]').val(response.condition).prop('disabled', true);
                        $('#editButton').show();  // Show Edit button again
                        $('#saveButton').hide();   // Hide Save button
                    } else {
                        $('#responseMessage').html('<div class="alert alert-danger">There was an error updating the patient details.</div>');
                    }
                },
                error: function(xhr, status, error) {
                    $('#responseMessage').html('<div class="alert alert-danger">An error occurred. Please try again.</div>');
                }
            });
        });
    });
</script>

{% endblock content %}
